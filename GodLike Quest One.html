<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Quest ‚Äî Juego Educativo</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#9aa7b2; --good:#16a34a; --bad:#ef4444;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,"Helvetica Neue",Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071023 0%, #05202b 100%);color:#e6eef2}
  .app{
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;
  }
  .container{
    width:100%;max-width:980px;background:linear-gradient(180deg,var(--card), rgba(6,10,16,0.6));
    border-radius:14px;padding:22px;box-shadow:0 8px 30px rgba(2,6,23,0.7);
    display:grid;grid-template-columns: 320px 1fr;gap:18px;
  }
  header{grid-column:1/-1;display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
  .controls{display:flex;gap:10px;align-items:center}
  select,input[type=range]{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted)}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  }
  .left{display:flex;flex-direction:column;gap:12px}
  .center{display:flex;flex-direction:column;gap:12px;padding:6px}
  .big-question{font-size:28px;text-align:center;padding:16px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .answers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button.btn{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px;color:var(--muted);
    cursor:pointer;font-weight:600;
  }
  button.btn:active{transform:translateY(1px)}
  .status{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .stat{background:var(--glass);padding:10px;border-radius:10px;min-width:88px;text-align:center}
  .timer{font-size:18px;font-weight:700;color:var(--accent)}
  .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:10px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7c3aed);width:0%}
  .small{font-size:12px;color:var(--muted)}
  .topbar-hint{font-size:13px;color:var(--muted)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;padding-top:6px}
  .result{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .explanation{margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
  .danger{color:var(--bad);font-weight:700}
  .good{color:var(--good);font-weight:700}
  @media (max-width:880px){
    .container{grid-template-columns:1fr; padding:14px}
    .left{order:2}
  }
</style>
</head>
<body>
  <div class="app">
    <div class="container" role="application" aria-label="Math Quest juego educativo">
      <header>
        <h1>üß† Math Quest <span class="small">‚Äî Practica aritm√©tica r√°pido</span></h1>
        <div class="controls">
          <label class="topbar-hint small">Dificultad
            <select id="difficulty" aria-label="Seleccionar dificultad">
              <option value="easy">F√°cil</option>
              <option value="medium" selected>Media</option>
              <option value="hard">Dif√≠cil</option>
            </select>
          </label>
          <label class="topbar-hint small">Tiempo/pregunta
            <select id="timePerQuestion" aria-label="Tiempo por pregunta">
              <option value="12">12s</option>
              <option value="18" selected>18s</option>
              <option value="25">25s</option>
            </select>
          </label>
          <button id="startBtn" class="btn" aria-label="Comenzar juego">Iniciar</button>
        </div>
      </header>

      <aside class="left panel" aria-hidden="false">
        <div class="stat">
          <div class="small">Puntuaci√≥n</div>
          <div id="score" style="font-size:20px;font-weight:800">0</div>
        </div>
        <div class="stat">
          <div class="small">Vidas</div>
          <div id="lives" style="font-size:20px;font-weight:800">3</div>
        </div>
        <div class="stat">
          <div class="small">Racha</div>
          <div id="streak" style="font-size:20px;font-weight:800">0</div>
        </div>

        <div class="panel" style="margin-top:8px">
          <div class="small">R√©cord</div>
          <div id="highscore" style="font-size:18px;font-weight:700">0</div>
          <div class="small" style="margin-top:8px">Guarda tu r√©cord localmente en este navegador.</div>
        </div>

        <div class="panel" style="margin-top:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="small">Progreso</div>
            <div class="small" id="qcount">0/10</div>
          </div>
          <div class="progress" aria-hidden="true" style="margin-top:8px"><i id="progressBar"></i></div>
        </div>

        <div class="panel" style="margin-top:8px">
          <div class="small">Controles r√°pidos</div>
          <ul class="small" style="padding-left:18px;margin:8px 0 0 0;color:var(--muted)">
            <li>Teclas 1‚Äì4 para responder</li>
            <li>H para pista (cuesta puntos)</li>
            <li>R para reiniciar partida</li>
          </ul>
        </div>
      </aside>

      <main class="center">
        <div class="panel">
          <div class="big-question" id="question">Pulsa <strong>Iniciar</strong> para comenzar</div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <div class="timer" id="timer">--</div>
            <div class="small">Tiempo restante</div>
            <div style="flex:1"></div>
            <button id="hintBtn" class="btn" title="Mostrar pista (rebaja puntos)">üí° Pista</button>
            <button id="skipBtn" class="btn" title="Saltar pregunta (pierdes vida)">‚è≠ Saltar</button>
          </div>
          <div class="answers" style="margin-top:12px" id="answers" role="list"></div>
          <div class="explanation small" id="explanation" style="display:none"></div>
        </div>

        <div class="panel" style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="small">Configuraci√≥n extra</div>
            <div class="small">Preguntas por partida
              <select id="questionsPerGame" aria-label="Preguntas por partida">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
              </select>
            </div>
          </div>
          <div style="margin-top:8px;color:var(--muted)">El sistema genera operaciones y tambi√©n ense√±a la explicaci√≥n de la respuesta tras cada intento.</div>
        </div>

        <div class="panel" style="margin-top:10px">
          <div class="result">
            <div class="small">Estado: <span id="statusText">Esperando</span></div>
            <div class="small">√öltimo cambio: <span id="lastChange">‚Äî</span></div>
          </div>
        </div>
      </main>

      <footer>
        <div class="small">Math Quest ‚Äî Hecho con ‚ù§Ô∏è ‚Äî Guarda el archivo y √°brelo en tu navegador. Versi√≥n 1.0</div>
      </footer>
    </div>
  </div>

<script>
/* Math Quest ‚Äî l√≥gica del juego */
(() => {
  // Elementos
  const startBtn = document.getElementById('startBtn');
  const difficultyEl = document.getElementById('difficulty');
  const timePerQuestionEl = document.getElementById('timePerQuestion');
  const questionsPerGameEl = document.getElementById('questionsPerGame');
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const streakEl = document.getElementById('streak');
  const highscoreEl = document.getElementById('highscore');
  const questionEl = document.getElementById('question');
  const answersEl = document.getElementById('answers');
  const timerEl = document.getElementById('timer');
  const explanationEl = document.getElementById('explanation');
  const hintBtn = document.getElementById('hintBtn');
  const skipBtn = document.getElementById('skipBtn');
  const progressBar = document.getElementById('progressBar');
  const qcountEl = document.getElementById('qcount');
  const statusText = document.getElementById('statusText');
  const lastChange = document.getElementById('lastChange');

  // Estado
  let game = null;
  const HS_KEY = 'mathquest_highscore_v1';

  function loadHighscore(){ return parseInt(localStorage.getItem(HS_KEY)) || 0; }
  function saveHighscore(v){ localStorage.setItem(HS_KEY, String(v)); }

  highscoreEl.textContent = loadHighscore();

  // Generador de preguntas
  function randint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  function generateQuestion(difficulty){
    let ops = ['+','-','√ó','√∑'];
    let op = ops[randint(0,ops.length-1)];
    let a,b,answer,explain;
    const dd = difficulty;
    if(dd === 'easy'){
      a = randint(1,12);
      b = randint(1,12);
    } else if(dd === 'medium'){
      a = randint(2,30);
      b = randint(2,20);
    } else {
      a = randint(5,120);
      b = randint(2,40);
    }

    // For division prefer clean results sometimes
    if(op === '√∑'){
      // make a divisible
      const prod = a * b;
      a = prod;
      answer = a / b;
      explain = `${a} √∑ ${b} = ${answer}`;
    } else if(op === '√ó'){
      answer = a * b;
      explain = `${a} √ó ${b} = ${answer}`;
    } else if(op === '+'){
      answer = a + b;
      explain = `${a} + ${b} = ${answer}`;
    } else { // -
      // ensure some negatives occasionally
      if(Math.random() < 0.2) { answer = a - b; } else { if(a<b){ [a,b] = [b,a]; } answer = a - b; }
      explain = `${a} - ${b} = ${answer}`;
    }
    if(!explain) explain = `Respuesta: ${answer}`;

    // generate choices (4 options)
    let choices = new Set();
    choices.add(answer);
    while(choices.size < 4){
      // small perturbations
      let perturb = Math.max(1, Math.round(Math.abs(answer) * (0.05 + Math.random()*0.4)));
      let sign = Math.random() < 0.5 ? -1 : 1;
      let candidate = answer + sign * randint(1, Math.max(2,perturb));
      // avoid divide decimal clutter: round for division if needed
      if(op==='√∑') candidate = Math.round(candidate*100)/100;
      choices.add(candidate);
    }
    // shuffle choices
    choices = Array.from(choices).sort(()=>Math.random()-0.5);

    return {
      op, a, b, answer, explain, choices, raw: `${a} ${op} ${b}`
    };
  }

  // UI helpers
  function setStatus(text){ statusText.textContent = text; }
  function setLastChange(t){ lastChange.textContent = t; }
  function updateProgress(){
    const pct = (game.currentIndex / game.totalQuestions) * 100;
    progressBar.style.width = pct + '%';
    qcountEl.textContent = `${game.currentIndex}/${game.totalQuestions}`;
  }
  function renderQuestion(q){
    questionEl.innerHTML = `<div aria-hidden="true">${q.raw}</div>`;
    answersEl.innerHTML = '';
    explanationEl.style.display = 'none';
    // Build answer buttons
    q.choices.forEach((c, idx) => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.setAttribute('data-choice', String(c));
      // show integers without decimals
      btn.innerHTML = `<strong>${idx+1}.</strong> &nbsp; ${Number.isInteger(c) ? c : c.toFixed(2)}`;
      btn.onclick = () => handleAnswer(c, btn);
      answersEl.appendChild(btn);
    });
  }

  // Scoring: base points + time bonus + streak multiplier
  function calcPoints(baseTimeLeft){
    const base = 100;
    const timeBonus = Math.max(0, Math.round(baseTimeLeft * 5)); // 5 pts per second left
    const streakMult = 1 + Math.min(0.5, game.streak * 0.05); // up to +50%
    return Math.round((base + timeBonus) * streakMult);
  }

  // Start / Reset
  startBtn.addEventListener('click', startGame);
  hintBtn.addEventListener('click', useHint);
  skipBtn.addEventListener('click', skipQuestion);

  function startGame(){
    // initialize state
    game = {
      difficulty: difficultyEl.value,
      timePerQuestion: parseInt(timePerQuestionEl.value),
      totalQuestions: parseInt(questionsPerGameEl.value),
      currentIndex: 0,
      score: 0,
      lives: 3,
      streak: 0,
      timerId: null,
      timeLeft: 0,
      activeQuestion: null,
      waitingAnswer: false
    };
    scoreEl.textContent = game.score;
    livesEl.textContent = game.lives;
    streakEl.textContent = game.streak;
    setStatus('Jugando');
    setLastChange('Comenz√≥ el juego');
    updateProgress();
    nextQuestion();
  }

  function endGame(reason){
    clearTimer();
    setStatus('Terminado');
    setLastChange(reason || 'Partida finalizada');
    questionEl.innerHTML = `<strong>Juego terminado</strong><div style="font-size:13px;color:var(--muted);margin-top:6px">Puntuaci√≥n final: <span style="font-weight:800">${game.score}</span></div>`;
    answersEl.innerHTML = '';
    explanationEl.style.display = 'block';
    explanationEl.textContent = `¬°Buen trabajo! Tu puntuaci√≥n: ${game.score}. R√©cord anterior: ${loadHighscore()}.`;
    // update highscore
    const prev = loadHighscore();
    if(game.score > prev){
      saveHighscore(game.score);
      highscoreEl.textContent = game.score;
      explanationEl.textContent += ' üèÜ Nuevo r√©cord guardado.';
    }
    game = null;
  }

  // timer helpers
  function clearTimer(){
    if(game && game.timerId) {
      clearInterval(game.timerId);
      game.timerId = null;
    }
  }

  function startTimer(){
    game.timeLeft = game.timePerQuestion;
    timerEl.textContent = game.timeLeft + 's';
    const start = Date.now();
    game.timerId = setInterval(()=>{
      const elapsed = Math.floor((Date.now() - start)/1000);
      const remaining = Math.max(0, game.timePerQuestion - elapsed);
      game.timeLeft = remaining;
      timerEl.textContent = remaining + 's';
      if(remaining <= 0){
        // time up
        clearTimer();
        handleTimeout();
      }
    }, 250);
  }

  function handleTimeout(){
    if(!game) return;
    setLastChange('Tiempo agotado');
    game.lives -= 1;
    livesEl.textContent = game.lives;
    game.streak = 0;
    streakEl.textContent = game.streak;
    showExplanation(false, `Se agot√≥ el tiempo. La respuesta correcta era ${formatAnswer(game.activeQuestion.answer)}. ${game.activeQuestion.explain}`);
    game.currentIndex++;
    updateProgress();
    if(game.lives <= 0 || game.currentIndex >= game.totalQuestions) {
      endGame('Sin vidas o preguntas completadas');
    } else {
      setTimeout(nextQuestion, 1600);
    }
  }

  function formatAnswer(a){ return Number.isInteger(a) ? String(a) : a.toFixed(2); }

  function nextQuestion(){
    if(!game) return;
    if(game.currentIndex >= game.totalQuestions){
      endGame('Todas las preguntas respondidas');
      return;
    }
    const q = generateQuestion(game.difficulty);
    game.activeQuestion = q;
    renderQuestion(q);
    game.waitingAnswer = true;
    startTimer();
  }

  function handleAnswer(choice, btnEl){
    if(!game || !game.waitingAnswer) return;
    game.waitingAnswer = false;
    clearTimer();
    const correct = Math.abs(Number(choice) - Number(game.activeQuestion.answer)) < 1e-6;
    if(correct){
      // points
      const pts = calcPoints(game.timeLeft);
      game.score += pts;
      game.streak += 1;
      setLastChange(`Respuesta correcta (+${pts} pts)`);
      scoreEl.textContent = game.score;
      streakEl.textContent = game.streak;
      btnEl.style.borderColor = 'rgba(0,0,0,0.6)';
      btnEl.style.background = 'linear-gradient(90deg,#05202b, #07323b)';
      showExplanation(true, game.activeQuestion.explain + ` ‚Äî Ganaste ${pts} puntos.`);
    } else {
      game.lives -= 1;
      game.streak = 0;
      setLastChange('Respuesta incorrecta');
      livesEl.textContent = game.lives;
      streakEl.textContent = game.streak;
      btnEl.style.background = 'linear-gradient(90deg,#2b0b0b, #3b0711)';
      showExplanation(false, `Incorrecto. La respuesta correcta era ${formatAnswer(game.activeQuestion.answer)}. ${game.activeQuestion.explain}`);
    }
    game.currentIndex++;
    updateProgress();

    // next or end
    if(game.lives <= 0 || game.currentIndex >= game.totalQuestions){
      setTimeout(()=> endGame('Partida finalizada'), 1400);
    } else {
      setTimeout(nextQuestion, 1400);
    }
  }

  function showExplanation(correct, text){
    explanationEl.style.display = 'block';
    explanationEl.textContent = text;
    explanationEl.className = 'explanation small ' + (correct ? 'good' : 'danger');
  }

  function useHint(){
    if(!game || !game.waitingAnswer) return;
    // cost points and reveal a wrong choice to remove
    const cost = 30;
    if(game.score < cost){
      setLastChange('No hay suficientes puntos para pista');
      return;
    }
    game.score = Math.max(0, game.score - cost);
    scoreEl.textContent = game.score;
    setLastChange('Us√≥ pista (-30 pts)');
    // remove one wrong button visually
    const buttons = Array.from(answersEl.querySelectorAll('button'));
    const wrongBtns = buttons.filter(b => Number(b.getAttribute('data-choice')) !== Number(game.activeQuestion.answer));
    if(wrongBtns.length){
      const removeBtn = wrongBtns[randint(0, wrongBtns.length-1)];
      removeBtn.disabled = true;
      removeBtn.style.opacity = '0.4';
      removeBtn.style.transform = 'scale(0.98)';
      showExplanation(false, 'Pista aplicada: una opci√≥n incorrecta ha sido desactivada. -30 pts');
    }
  }

  function skipQuestion(){
    if(!game || !game.waitingAnswer) return;
    setLastChange('Pregunta saltada (-1 vida)');
    clearTimer();
    game.lives -= 1;
    game.streak = 0;
    livesEl.textContent = game.lives;
    streakEl.textContent = game.streak;
    showExplanation(false, `Saltaste la pregunta. La respuesta correcta era ${formatAnswer(game.activeQuestion.answer)}.`);
    game.currentIndex++;
    updateProgress();
    if(game.lives <= 0 || game.currentIndex >= game.totalQuestions) endGame('Sin vidas o preguntas completadas');
    else setTimeout(nextQuestion, 1300);
  }

  // keyboard shortcuts 1-4, H (hint), R (restart)
  window.addEventListener('keydown', (e) => {
    if(!game) {
      if(e.key.toLowerCase() === 'r') startGame();
      return;
    }
    if(!game.waitingAnswer) return;
    if(['1','2','3','4'].includes(e.key)){
      const idx = parseInt(e.key) - 1;
      const btn = answersEl.querySelectorAll('button')[idx];
      if(btn && !btn.disabled) btn.click();
    } else if(e.key.toLowerCase() === 'h'){
      useHint();
    } else if(e.key.toLowerCase() === 'r'){
      // quick restart
      startGame();
    }
  });

  // accessibility: allow tab focus and enter on choices (buttons already handle)
  // initial UI
  timerEl.textContent = '--';
  setStatus('Listo');
  setLastChange('Esperando inicio');

  // small utility: ensure numbers are rendered nicely in choices (for divide)
  // already handled during generation

})();
</script>
</body>
</html>
